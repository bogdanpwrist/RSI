<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Email Encryption System</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; background: #f4f4f4; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        textarea { min-height: 120px; }
        button { background-color: #4CAF50; color: white; padding: 12px 30px; border: none; border-radius: 4px; cursor: pointer; width: 100%; }
        button:hover { background-color: #45a049; }
        .message { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .storage-controls { margin-top: 30px; display: flex; gap: 10px; }
        .storage-controls button { flex: 1; background-color: #2196F3; }
        .storage-controls button:last-child { background-color: #f44336; }
        .storage-controls button:last-child:hover { background-color: #d7372c; }
        .tables-grid { margin-top: 20px; display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .table-wrapper { background: #fff; border-radius: 6px; border: 1px solid #e0e0e0; padding: 15px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        .table-wrapper h3 { margin-top: 0; font-size: 18px; color: #333; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border-bottom: 1px solid #e6e6e6; padding: 8px; text-align: left; }
        th { background: #f0f4ff; color: #1a237e; }
        td .tag { display: inline-block; background: #e3f2fd; color: #1565c0; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        tr:last-child td { border-bottom: none; }
        .empty { text-align: center; color: #777; font-style: italic; }
        .services-control { background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ddd; }
        .services-control h3 { margin-top: 0; font-size: 16px; color: #333; }
        .service-switch { display: flex; justify-content: space-between; align-items: center; margin: 12px 0; padding: 10px; background: white; border-radius: 4px; }
        .service-switch label { font-weight: normal; color: #555; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(26px); }
        .service-status { font-size: 12px; margin-left: 10px; padding: 2px 8px; border-radius: 4px; }
        .status-enabled { background: #d4edda; color: #155724; }
        .status-disabled { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📧 Email Encryption System</h1>
        <div class="services-control">
            <h3>⚙️ Zarządzanie serwisami</h3>
            <div class="service-switch">
                <label for="gmailSwitch">
                    Gmail
                    <span class="service-status status-enabled" id="gmailStatus">Włączony</span>
                </label>
                <label class="switch">
                    <input type="checkbox" id="gmailSwitch" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="service-switch">
                <label for="wpSwitch">
                    WP
                    <span class="service-status status-enabled" id="wpStatus">Włączony</span>
                </label>
                <label class="switch">
                    <input type="checkbox" id="wpSwitch" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="service-switch">
                <label for="otherSwitch">
                    Inne serwisy
                    <span class="service-status status-enabled" id="otherStatus">Włączony</span>
                </label>
                <label class="switch">
                    <input type="checkbox" id="otherSwitch" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <form id="emailForm">
            <div class="form-group">
                <label for="email">Email Address:</label>
                <input type="email" id="email" required placeholder="example@domain.com">
            </div>
            <div class="form-group">
                <label for="content">Message:</label>
                <textarea id="content" required placeholder="Enter your message..."></textarea>
            </div>
            <button type="submit">🔒 Encrypt & Send</button>
        </form>
        <div id="message" class="message"></div>
        <div class="storage-controls">
            <button type="button" id="loadStorageBtn">📦 Pobierz magazyny</button>
            <button type="button" id="clearStorageBtn">🧹 Wyczyść magazyny</button>
        </div>
        <div id="storageMessage" class="message"></div>
        <div class="tables-grid">
            <div class="table-wrapper">
                <h3 id="domainTitle1">Magazyn 1</h3>
                <table>
                    <thead>
                        <tr><th>Adres</th><th>Szyfrogram</th><th>Czas</th></tr>
                    </thead>
                    <tbody id="domainBody1"><tr><td colspan="3" class="empty">Brak danych</td></tr></tbody>
                </table>
            </div>
            <div class="table-wrapper">
                <h3 id="domainTitle2">Magazyn 2</h3>
                <table>
                    <thead>
                        <tr><th>Adres</th><th>Szyfrogram</th><th>Czas</th></tr>
                    </thead>
                    <tbody id="domainBody2"><tr><td colspan="3" class="empty">Brak danych</td></tr></tbody>
                </table>
            </div>
            <div class="table-wrapper">
                <h3 id="domainTitle3">Magazyn 3</h3>
                <table>
                    <thead>
                        <tr><th>Adres</th><th>Szyfrogram</th><th>Czas</th></tr>
                    </thead>
                    <tbody id="domainBody3"><tr><td colspan="3" class="empty">Brak danych</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // Service toggle functionality
        const services = ['gmail', 'wp', 'other'];
        
        async function updateServiceStatus(serviceName, enabled) {
            try {
                const action = enabled ? 'activate' : 'disable';
                const response = await fetch(`http://localhost:7000/api/services/${serviceName}/${action}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to update service status');
                }
                
                const result = await response.json();
                const statusSpan = document.getElementById(serviceName + 'Status');
                
                if (result.status === 'ACTIVE') {
                    statusSpan.textContent = 'Włączony';
                    statusSpan.className = 'service-status status-enabled';
                } else {
                    statusSpan.textContent = 'Wyłączony';
                    statusSpan.className = 'service-status status-disabled';
                }
            } catch (error) {
                console.error('Error updating service status:', error);
                alert('Błąd: ' + error.message);
                // Revert the switch
                document.getElementById(serviceName + 'Switch').checked = !enabled;
            }
        }
        
        async function loadServiceStatuses() {
            try {
                const response = await fetch('http://localhost:7000/api/services/status');
                if (!response.ok) {
                    throw new Error('Failed to load service statuses');
                }
                
                const statuses = await response.json();
                services.forEach(service => {
                    const status = statuses[service];
                    const enabled = (status === 'ACTIVE');
                    document.getElementById(service + 'Switch').checked = enabled;
                    const statusSpan = document.getElementById(service + 'Status');
                    if (enabled) {
                        statusSpan.textContent = 'Włączony';
                        statusSpan.className = 'service-status status-enabled';
                    } else {
                        statusSpan.textContent = 'Wyłączony';
                        statusSpan.className = 'service-status status-disabled';
                    }
                });
            } catch (error) {
                console.error('Error loading service statuses:', error);
            }
        }
        
        // Add event listeners for switches
        services.forEach(service => {
            document.getElementById(service + 'Switch').addEventListener('change', function() {
                updateServiceStatus(service, this.checked);
            });
        });
        
        // Load service statuses on page load
        loadServiceStatuses();
        
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const content = document.getElementById('content').value;
            const messageDiv = document.getElementById('message');
            try {
                const response = await fetch('http://localhost:7000/api/email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: email, body: content })
                });
                if (response.ok) {
                    const result = await response.json();
                    messageDiv.className = 'message success';
                    messageDiv.textContent = '✓ ' + result.message;
                    messageDiv.style.display = 'block';
                    document.getElementById('emailForm').reset();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to send');
                }
            } catch (error) {
                messageDiv.className = 'message error';
                messageDiv.textContent = '✗ Error: ' + error.message;
                messageDiv.style.display = 'block';
            }
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        });

        const storageMessage = document.getElementById('storageMessage');
        const storageTables = [
            { title: document.getElementById('domainTitle1'), body: document.getElementById('domainBody1') },
            { title: document.getElementById('domainTitle2'), body: document.getElementById('domainBody2') },
            { title: document.getElementById('domainTitle3'), body: document.getElementById('domainBody3') }
        ];

        function showStorageMessage(type, text) {
            storageMessage.className = 'message ' + type;
            storageMessage.textContent = text;
            storageMessage.style.display = 'block';
            setTimeout(() => { storageMessage.style.display = 'none'; }, 6000);
        }

        function resetTable(table, placeholder) {
            table.body.innerHTML = '<tr><td colspan="3" class="empty">' + placeholder + '</td></tr>';
        }

        function populateTable(table, domain, emails) {
            table.title.textContent = domain ? domain : 'Magazyn';
            if (!emails || emails.length === 0) {
                resetTable(table, 'Brak danych');
                return;
            }

            table.body.innerHTML = '';
            emails.forEach(email => {
                const row = document.createElement('tr');
                const addressCell = document.createElement('td');
                const addressWrapper = document.createElement('span');
                addressWrapper.textContent = email.address || '—';
                if (email.domain) {
                    const domainTag = document.createElement('span');
                    domainTag.className = 'tag';
                    domainTag.textContent = email.domain;
                    addressWrapper.appendChild(document.createTextNode(' '));
                    addressWrapper.appendChild(domainTag);
                }
                addressCell.appendChild(addressWrapper);
                const bodyCell = document.createElement('td');
                const fullBody = email.encryptedBody || '';
                const bodyPreview = fullBody.substring(0, 32);
                bodyCell.textContent = bodyPreview ? bodyPreview + (fullBody.length > 32 ? '…' : '') : '—';
                const timeCell = document.createElement('td');
                timeCell.textContent = email.timestamp ? new Date(email.timestamp).toLocaleString() : '—';

                row.appendChild(addressCell);
                row.appendChild(bodyCell);
                row.appendChild(timeCell);
                table.body.appendChild(row);
            });
        }

        function renderStorages(payload) {
            const domains = (payload && payload.domains) ? payload.domains : [];
            const emailsMap = (payload && payload.emails) ? payload.emails : {};

            storageTables.forEach((table, index) => {
                const domain = domains[index];
                if (!domain) {
                    table.title.textContent = 'Magazyn ' + (index + 1);
                    resetTable(table, 'Brak danych');
                    return;
                }
                populateTable(table, domain, emailsMap[domain]);
            });
        }

        document.getElementById('loadStorageBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('http://localhost:7000/api/storage');
                if (!response.ok) {
                    throw new Error('Nie udało się pobrać magazynów');
                }
                const data = await response.json();
                renderStorages(data);
                const count = data.totalEmails ?? 0;
                showStorageMessage('success', 'Załadowano magazyny. Łącznie ' + count + ' wiadomości.');
            } catch (error) {
                renderStorages(null);
                showStorageMessage('error', error.message);
            }
        });

        document.getElementById('clearStorageBtn').addEventListener('click', async () => {
            const confirmClear = window.confirm('Czy na pewno chcesz usunąć wszystkie magazyny?');
            if (!confirmClear) {
                return;
            }
            try {
                const response = await fetch('http://localhost:7000/api/storage', { method: 'DELETE' });
                if (!response.ok) {
                    throw new Error('Nie udało się wyczyścić magazynów');
                }
                const report = await response.json();
                renderStorages(null);
                const deleted = report.deletedEmails ?? 0;
                showStorageMessage('success', 'Wyczyszczono magazyny. Usunięto ' + deleted + ' wiadomości.');
            } catch (error) {
                showStorageMessage('error', error.message);
            }
        });

        renderStorages(null);
    </script>
</body>
</html>
